<!DOCTYPE html>
<!--
Vehicle calc needs:
special parts ( like bigger buggy boot)
weights
export to csv

Base build calc needs:
total storage
export to csv
-->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dune Cost Calculator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="container">
      <h1>Dune Cost Calculator</h1>
      <div class="toggle-group">
        <div>
          <div id="viewButtons" class="view-toggle">
            <button id="btnBuildings">Buildings</button>
            <button id="btnVehicles">Vehicles</button>
          </div>
        </div>
        <div>
          <label>Dark Mode <input type="checkbox" id="darkModeToggle" /></label>
        </div>
      </div>

      <!-- BUILDING CALC -->
      <div id="buildingCalc">
        <button class="resetBuildings">Reset</button>
        <label
          ><input type="checkbox" id="deepDesertTop" /> Deep Desert 50%
          cost</label
        >
        <br /><br />
        <div id="buildingList" class="building-grid"></div>
        <div class="totals-flex">
          <div class="totals">
            <strong>Total Resources Required:</strong>
            <ul id="totalResources"></ul>
            <strong>Total Power: </strong><br />
            <img class="icon" src="./Images/Icons/power.png" />
            <span id="powerUsage" class="power-display">0</span> used /
            <span id="powerGenerated" class="power-display">0</span> generated
            <br /><br />
            <strong>Total Weight: </strong><br />
            <span id="weightUsage" class="weight-display">0v</span>
            <br /><br />
            <strong>Total Water Storage: </strong><br />
            <span id="waterStorage" class="water-display">0ml</span>
            <br /><br />
            <strong>Total Storage: </strong><br />
            <span id="storage" class="storage-display">0v</span>
            <br /><br />
            <strong>Total Storage Slots: </strong><br />
            <span id="storageSlots" class="storage-display">0</span>
          </div>
          <div class="totals">
            <div class="selected-block">
              <strong>Selected Buildings:</strong>
              <br /><br />
              <ul id="selectedBuildings" class="buildings-display"></ul>
            </div>
          </div>
        </div>
        <br />
        <button class="resetBuildings">Reset</button>
        <label
          ><input type="checkbox" id="deepDesertBottom" /> Deep Desert 50%
          cost</label
        >
      </div>

      <!-- VEHICLE CALC -->
      <div id="vehicleCalc" class="hidden">
        <button id="resetVehiclestop">Reset</button>
        <br />
        <label for="vehicleSelect">Select Vehicle:</label>
        <select id="vehicleSelect">
          <option value="">-- Choose Vehicle --</option>
        </select>
        <br />
        <label for="buildAmount">Amount:</label>
        <input
          type="number"
          id="buildAmount"
          value="1"
          min="1"
          style="width: 40px"
        />
        <div id="selectedVehicle"></div>
        <div id="imageholder" class="flex-row">
          <div id="requiredParts" class="flex-column"></div>
          <div id="vehicleImage" class="flex-column"></div>
        </div>
        <div id="optionalParts"></div>
        <div id="conflictWarning" class="conflict-msg"></div>
        <div id="totalCost"></div>
        <br />
        <button id="resetVehicles">Reset</button>
      </div>
    </div>

    <script>
      // UI Toggles
      const body = document.body;
      const darkToggle = document.getElementById("darkModeToggle");
      const buildingCalc = document.getElementById("buildingCalc");
      const vehicleCalc = document.getElementById("vehicleCalc");

      // Persisted Preferences
      if (localStorage.getItem("darkMode") === "true") {
        body.classList.add("dark");
        darkToggle.checked = true;
      }
      if (localStorage.getItem("activeCalc") === "vehicle") {
        buildingCalc.classList.add("hidden");
        vehicleCalc.classList.remove("hidden");
      }

      darkToggle.addEventListener("change", () => {
        body.classList.toggle("dark", darkToggle.checked);
        localStorage.setItem("darkMode", darkToggle.checked);
      });

      const btnBuildings = document.getElementById("btnBuildings");
      const btnVehicles = document.getElementById("btnVehicles");

      function setView(mode) {
        const isVehicle = mode === "vehicle";

        buildingCalc.classList.toggle("hidden", isVehicle);
        vehicleCalc.classList.toggle("hidden", !isVehicle);

        btnVehicles.classList.toggle("active", isVehicle);
        btnBuildings.classList.toggle("active", !isVehicle);

        localStorage.setItem("activeCalc", mode);
      }

      // Apply initial state from localStorage
      setView(localStorage.getItem("activeCalc") || "building");

      // Button listeners
      btnBuildings.addEventListener("click", () => setView("building"));
      btnVehicles.addEventListener("click", () => setView("vehicle"));

      // BUILDING LOGIC
      fetch("Data/buildings.json")
        .then((res) => res.json())
        .then((buildings) => {
          const list = document.getElementById("buildingList");
          const total = document.getElementById("totalResources");
          const powerUsed = document.getElementById("powerUsage");
          const weightUsed = document.getElementById("weightUsage");
          const waterStorage = document.getElementById("waterStorage");
          const storage = document.getElementById("storage");
          const storageSlots = document.getElementById("storageSlots");
          const powerGen = document.getElementById("powerGenerated");
          const desertTop = document.getElementById("deepDesertTop");
          const desertBottom = document.getElementById("deepDesertBottom");

          // Restore values
          const savedQty = JSON.parse(
            localStorage.getItem("buildingQuantities") || "{}"
          );
          desertTop.checked = localStorage.getItem("deepDesertTop") === "true";
          desertBottom.checked =
            localStorage.getItem("deepDesertBottom") === "true";

          // Sync both checkboxes and recalc when either changes
          const syncDesertToggles = (source) => {
            const value = source.checked;
            desertTop.checked = value;
            desertBottom.checked = value;
            localStorage.setItem("deepDesert", value);
            calcBuildings();
          };

          desertTop.addEventListener("change", () =>
            syncDesertToggles(desertTop)
          );
          desertBottom.addEventListener("change", () =>
            syncDesertToggles(desertBottom)
          );

          buildings.forEach((bld, i) => {
            const div = document.createElement("div");
            div.className = "building";

            const fileName = bld.name.toLowerCase().replace(/\s+/g, "-");

            // Construct local image path
            const imageSrc = `./Images/Buildings/${fileName}.png`;

            const imageTag = `
            <img src="${imageSrc}" alt="${bld.name}" 
                class="building-image"
                onerror="this.style.display='none';"
            />
          `;

            const powerLine =
              bld.power !== 0
                ? `Power: <span class="value ${
                    bld.power > 0 ? "power-display green" : "power-display red"
                  }">
                ${bld.power > 0 ? "+" : ""}${bld.power}
              </span><br>`
                : "";

            const waterLine =
              bld.water !== 0
                ? `Water: <span class="water-display">${bld.water}ml</span><br>`
                : "";

            const storageLine =
              bld.storage !== 0
                ? `Storage: <span class="value">${bld.storage}v</span><br>`
                : "";
            const storageslotsLine =
              bld.storageslots !== 0
                ? `Storage Slots: <span class="value">${bld.storageslots}</span><br>`
                : "";

            div.innerHTML = `
              <div>
                <div class="buildTitle" style="margin-bottom: 5px;">${
                  bld.name
                }</div>
                <div style="display: flex; align-items: center;">
                  <div>
                    <span class="buildFont">
                      ${powerLine}
                      ${waterLine}
                      ${storageLine}
                      ${storageslotsLine}
                      Weight: <span class="value">${bld.weight.toFixed(
                        1
                      )}v</span><br>
                      <span class="quantityBuild">Quantity:</span> 
                      <input type="number" id="qty-${i}" value="${
              savedQty[i] || 0
            }" min="0" style="width: 40px;"/>
                    </span>
                  </div>
                  ${imageTag}
                </div>
              </div>
            `;

            list.appendChild(div);
          });

          function calcBuildings() {
            const selectedDisplay =
              document.getElementById("selectedBuildings");
            selectedDisplay.innerHTML = ""; // Clear list

            buildings.forEach((bld, i) => {
              let fileName = bld.name.toLowerCase().replace(/\s+/g, "-");
              let imageSrc = `./Images/Buildings/${fileName}.png`;
              let imageTagSmall = `
            <img src="${imageSrc}" alt="${bld.name}" 
                class="building-image-small"
                onerror="this.style.display='none';"
            />
          `;

              const qty =
                parseInt(document.getElementById(`qty-${i}`).value) || 0;
              if (qty > 0) {
                const li = document.createElement("li");
                li.innerHTML = `<span class="buildFont"><span class="value">${imageTagSmall} ${qty}x</span> ${bld.name}</span>`;
                selectedDisplay.appendChild(li);
              }
            });

            if (!selectedDisplay.children.length) {
              selectedDisplay.innerHTML = "<em>No buildings selected</em>";
            }

            const totals = {};
            let used = 0,
              generated = 0,
              totalWeight = 0,
              totalWater = 0,
              totalStorage = 0,
              totalStorageSlots = 0;
            const saveQty = {};
            buildings.forEach((bld, i) => {
              const qty =
                parseInt(document.getElementById(`qty-${i}`).value) || 0;
              saveQty[i] = qty;
              const power = bld.power * qty;
              power >= 0 ? (generated += power) : (used += Math.abs(power));
              totalWeight += bld.weight * qty;
              totalWater += bld.water * qty;
              totalStorage += bld.storage * qty;
              totalStorageSlots += bld.storageslots * qty;
              bld.components.forEach((c) => {
                const amt = desertTop.checked
                  ? Math.ceil(c.quantity / 2)
                  : c.quantity;
                totals[c.item] = (totals[c.item] || 0) + amt * qty;
              });
            });

            total.innerHTML = Object.entries(totals)
              .map(([item, qty]) => {
                let totalDisplay = "";
                const icon = `./Images/Icons/${item
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, "-")}.png`;
                if (qty <= 0) {
                  totalDisplay = "";
                } else {
                  totalDisplay = `<li><img class="icon" src="${icon}" /> <span class='buildFont'><span class='value'>${qty}x</span> ${item}</span></li>`;
                }
                return totalDisplay;
              })
              .join("");
            powerUsed.innerHTML = "<span class='buildFont'>" + used + "</span>";
            powerGen.innerHTML =
              "<span class='buildFont'>" + generated + "</span>";
            powerUsed.className =
              "power-display " + (used > generated ? "red" : "green");
            powerGen.className =
              "power-display " + (used > generated ? "red" : "green");
            waterStorage.innerHTML =
              "<span class='buildFont'><span class='water-display'>" +
              totalWater.toFixed(0) +
              "ml </span></span>";
            weightUsed.innerHTML =
              "<span class='buildFont'><span class='value'>" +
              totalWeight.toFixed(1) +
              "v </span></span>";
            storage.innerHTML =
              "<span class='buildFont'><span class='value'>" +
              totalStorage.toFixed(0) +
              "v</span></span>";
            storageSlots.innerHTML =
              "<span class='buildFont'><span class='value'>" +
              totalStorageSlots.toFixed(0) +
              "</span></span>";

            localStorage.setItem("buildingQuantities", JSON.stringify(saveQty));
            localStorage.setItem("deepDesertTop", desertTop.checked);
            localStorage.setItem("deepDesertBottom", desertBottom.checked);
          }

          list.addEventListener("input", calcBuildings);
          desertTop.addEventListener("change", calcBuildings);
          desertBottom.addEventListener("change", calcBuildings);

          document.querySelectorAll(".resetBuildings").forEach((btn) => {
            btn.addEventListener("click", () => {
              Array.from(
                document.querySelectorAll("#buildingList input[type=number]")
              ).forEach((input) => (input.value = 0));
              desertTop.checked = false;
              desertBottom.checked = false;
              localStorage.removeItem("buildingQuantities");
              localStorage.removeItem("deepDesertTop");
              localStorage.removeItem("deepDesertBottom");
              calcBuildings();
            });
          });

          calcBuildings();
        });

      // VEHICLE LOGIC
      fetch("Data/vehicles.json")
        .then((res) => res.json())
        .then((data) => {
          const select = document.getElementById("vehicleSelect");
          const amountInput = document.getElementById("buildAmount");
          const selVeh = document.getElementById("selectedVehicle");
          const reqParts = document.getElementById("requiredParts");
          const optParts = document.getElementById("optionalParts");
          const costDiv = document.getElementById("totalCost");
          const imageDiv = document.getElementById("vehicleImage");

          const types = [
            ...new Set(
              data.flatMap((v) => v.type.split(",").map((t) => t.trim()))
            ),
          ];

          types.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
          });

          // Restore
          select.value = localStorage.getItem("vehType") || "";
          amountInput.value = localStorage.getItem("vehAmount") || "1";

          function render() {
            const type = select.value;
            const amt = parseInt(amountInput.value) || 1;
            const match = data.filter((v) =>
              v.type
                .split(",")
                .map((t) => t.trim())
                .includes(type)
            );
            if (!match.length) return;

            localStorage.setItem("vehType", type);
            localStorage.setItem("vehAmount", amt);

            const name = type.split(" ").pop().toLowerCase();
            imageDiv.innerHTML = `<img class="vehicle-img" src="./Images/vehicles/${name}.png" />`;

            const optional = match.filter((v) => !v.required);
            optParts.innerHTML =
              '<strong>Optional Parts:</strong><form id="optForm"><ul>' +
              optional
                .map((v, i) => {
                  const checked = JSON.parse(
                    localStorage.getItem("vehOpts") || "[]"
                  ).includes(i);
                  let vItem = "";
                  if (v.unique) {
                    vItem = `<li><label><input type="checkbox" name="opt" value="${i}" ${
                      checked ? "checked" : ""
                    }/> <span class="value">${
                      (v.amount || 1) * amt
                    }x</span><span class="unique"> ${
                      v.name
                    }</span></label></li>`;
                  } else {
                    vItem = `<li><label><input type="checkbox" name="opt" value="${i}" ${
                      checked ? "checked" : ""
                    }/> <span class="value">${(v.amount || 1) * amt}x</span> ${
                      v.name
                    }</label></li>`;
                  }
                  return vItem;
                })
                .join("") +
              "</ul></form>";

            function updateCost() {
              const selectedCheckboxes = Array.from(
                document.querySelectorAll("#optForm input:checked")
              );
              const selected = selectedCheckboxes.map((e) => parseInt(e.value));
              localStorage.setItem("vehOpts", JSON.stringify(selected));

              const selectedOptionalIndexes = JSON.parse(
                localStorage.getItem("vehOpts") || "[]"
              );
              const selectedOptionalNames = selectedOptionalIndexes.map((i) =>
                (match.filter((v) => !v.required)[i]?.name || "").toLowerCase()
              );
              const amt2 = parseInt(amountInput.value) || 1; // <-- Add this line

              reqParts.innerHTML =
                "<strong>Required Parts:</strong><ul>" +
                match
                  .filter((v) => v.required)
                  .filter((v) => {
                    const name = v.name.toLowerCase();
                    // Hide required engine if optional engine is selected
                    if (name.includes("engine")) {
                      return !selectedOptionalNames.some((opt) =>
                        opt.includes("engine")
                      );
                    }
                    return true;
                  })
                  .map(
                    (v) =>
                      `<li><span class="value">${
                        (v.amount || 1) * amt2
                      }x</span> ${v.name}</li>`
                  )
                  .join("") +
                "</ul>";

              // Clear previous styles
              document
                .querySelectorAll("#optForm li")
                .forEach((li) => li.classList.remove("conflict"));
              const conflictWarning =
                document.getElementById("conflictWarning");
              conflictWarning.innerHTML = "";

              const selectedParts = selected.map((i) =>
                optional[i].name.toLowerCase()
              );
              const type = select.value.toLowerCase();

              const conflictMessages = [];
              const conflictIndexes = [];

              // Storage + Rocket
              const rocketIdx = selected.filter((i) =>
                optional[i].name.toLowerCase().includes("rocket launcher")
              );
              const storageIdx = selected.filter((i) =>
                optional[i].name.toLowerCase().includes("storage")
              );
              if (rocketIdx.length > 0 && storageIdx.length > 0) {
                conflictMessages.push(
                  "You can't have both Storage and Rocket."
                );
                conflictIndexes.push(...rocketIdx, ...storageIdx);
              }

              // Buggy + multiple Cutterrays
              if (type.includes("buggy")) {
                const cutterIdx = selected.filter((i) =>
                  optional[i].name.toLowerCase().includes("cutteray")
                );
                if (cutterIdx.length > 1) {
                  conflictMessages.push(
                    "You can only have 1 Cutteray on a Buggy."
                  );
                  conflictIndexes.push(...cutterIdx);
                }
              }

              // Buggy + boot/util/storage
              if (type.includes("buggy")) {
                const exclusiveIdx = selected.filter((i) => {
                  const name = optional[i].name.toLowerCase();
                  return (
                    name.includes("boot") ||
                    name.includes("boost") ||
                    name.includes("storage") ||
                    name.includes("utility")
                  );
                });
                if (exclusiveIdx.length > 1) {
                  conflictMessages.push(
                    "Buggy can only have 1 of Boot/Storage, Boost, or Utitly."
                  );
                  conflictIndexes.push(...exclusiveIdx);
                }
              }

              // Buggy + engine
              if (type.includes("buggy")) {
                const engineIdx = selected.filter((i) =>
                  optional[i].name.toLowerCase().includes("engine")
                );
                if (engineIdx.length > 1) {
                  conflictMessages.push(
                    "You can only have 1 engine on a Buggy."
                  );
                  conflictIndexes.push(...engineIdx);
                }
              }

              // Multiple Thrusters/Boosters
              const thrusterIdx = selected.filter((i) => {
                const name = optional[i].name.toLowerCase();
                return name.includes("thruster") || name.includes("boost");
              });
              if (thrusterIdx.length > 1) {
                conflictMessages.push(
                  "You can only have 1 Thruster or Booster per vehicle."
                );
                conflictIndexes.push(...thrusterIdx);
              }

              // Multiple Rockets
              const allRocketIdx = selected.filter((i) =>
                optional[i].name.toLowerCase().includes("rocket")
              );
              if (allRocketIdx.length > 1) {
                conflictMessages.push(
                  "You can only have 1 Rocket per vehicle."
                );
                conflictIndexes.push(...allRocketIdx);
              }

              // Sandbike exclusive slot
              if (type.includes("sandbike")) {
                const exclusiveIdx = selected.filter((i) => {
                  const name = optional[i].name.toLowerCase();
                  return (
                    name.includes("seat") ||
                    name.includes("inv") ||
                    name.includes("boost")
                  );
                });
                if (exclusiveIdx.length > 1) {
                  conflictMessages.push(
                    "Sandbike can only have 1 of Seat, Inventory, or Booster."
                  );
                  conflictIndexes.push(...exclusiveIdx);
                }
              }

              // sandbike + engine
              if (type.includes("sandbike")) {
                const engineIdx = selected.filter((i) =>
                  optional[i].name.toLowerCase().includes("engine")
                );
                if (engineIdx.length > 1) {
                  conflictMessages.push(
                    "You can only have 1 engine on a sandbike."
                  );
                  conflictIndexes.push(...engineIdx);
                }
              }

              // Show all conflict messages
              if (conflictMessages.length > 0) {
                conflictWarning.innerHTML = conflictMessages
                  .map((msg) => `⚠️ ${msg}`)
                  .join("<br>");
                conflictIndexes.forEach((i) => {
                  const li = document
                    .querySelector(`#optForm input[value="${i}"]`)
                    ?.closest("li");
                  if (li) li.classList.add("conflict");
                });
              }

              // === Cost Calculation ===
              const matCosts = {};
              const amt = parseInt(amountInput.value) || 1;

              [
                // Required parts, but skip engine if optional one is selected
                ...match.filter((v) => {
                  if (!v.required) return false;
                  const name = v.name.toLowerCase();
                  return !(
                    name.includes("engine") &&
                    selectedOptionalNames.some((opt) => opt.includes("engine"))
                  );
                }),
                // Include selected optional parts
                ...optional.filter((_, i) => selected.includes(i)),
              ].forEach((v) => {
                const mult = (v.amount || 1) * amt;
                v.components.forEach((c) => {
                  matCosts[c.item] =
                    (matCosts[c.item] || 0) + c.quantity * mult;
                });
              });

              const conflictingPartNames = conflictIndexes.map((i) =>
                optional[i].name.toLowerCase()
              );

              costDiv.innerHTML =
                "<strong>Total Cost:</strong><ul>" +
                Object.entries(matCosts)
                  .map(([item, qty]) => {
                    const icon = `./Images/Icons/${item
                      .toLowerCase()
                      .replace(/[^a-z0-9]+/g, "-")}.png`;
                    const lowerItem = item.toLowerCase();
                    const isSpice = lowerItem.includes("spice-infused");

                    const isConflict = conflictingPartNames.some((name) =>
                      lowerItem.includes(name)
                    );

                    const classes = [
                      isSpice ? "unique" : "",
                      isConflict ? "conflict" : "",
                    ]
                      .filter(Boolean)
                      .join(" ");

                    return `<li><img class="icon" src="${icon}" /><span class="value">${qty}x</span> <span class="${classes}">${item}</span></li>`;
                  })
                  .join("") +
                "</ul>";
              document.getElementById("resetVehicles").onclick = () => {
                localStorage.removeItem("vehType");
                localStorage.removeItem("vehAmount");
                localStorage.removeItem("vehOpts");
                select.value = "";
                amountInput.value = "1";
                selVeh.innerHTML =
                  reqParts.innerHTML =
                  optParts.innerHTML =
                  costDiv.innerHTML =
                  imageDiv.innerHTML =
                    "";
              };
              document.getElementById("resetVehiclestop").onclick = () => {
                localStorage.removeItem("vehType");
                localStorage.removeItem("vehAmount");
                localStorage.removeItem("vehOpts");
                select.value = "";
                amountInput.value = "1";
                selVeh.innerHTML =
                  reqParts.innerHTML =
                  optParts.innerHTML =
                  costDiv.innerHTML =
                  imageDiv.innerHTML =
                    "";
              };
            }

            document
              .getElementById("optForm")
              .addEventListener("change", updateCost);
            updateCost();
          }

          select.addEventListener("change", render);
          amountInput.addEventListener("input", render);
          if (select.value) render();
        });
    </script>
  </body>
</html>
